{% extends 'base.html' %}
{% block content %}
<h3>{{ 'Edit Matter' if matter else 'New Matter' }}</h3>
<form method="post" class="card shadow-sm">
  <div class="card-body">
    <div class="row g-3">
      {% for name in fields %}
        {% set value = (matter[name] if matter else '') %}
        <div class="col-md-6">
          <label class="form-label">{{ name }}</label>

          {# Long text #}
          {% if name in ['Commentary'] %}
            <textarea name="{{ name }}" class="form-control" rows="3">{{ value }}</textarea>

          {# Numeric #}
          {% elif name in ['Days with Legal', 'Total Cycle Time'] %}
            <input type="number" name="{{ name }}" class="form-control" value="{{ value }}">

          {# Dates #}
          {% elif name in ['Date Received', 'Date Closed'] %}
            <input type="date" name="{{ name }}" class="form-control" value="{{ value }}">

          {# Owner dropdown from users (with job title preview) #}
          {% elif name == 'Owner' %}
            <select name="Owner" class="form-select">
              <option value=""></option>
              {% for u in users %}
                <option value="{{ u['name'] }}" {% if value==u['name'] %}selected{% endif %}>
                  {{ u['name'] }}{% if u['job_title'] %} â€” {{ u['job_title'] }}{% endif %}
                </option>
              {% endfor %}
            </select>

          {# Controlled workflow statuses #}
          {% elif name == 'Overall Status' %}
            <select name="Overall Status" class="form-select" required>
              <option value="">Select status</option>
              {% for status in allowed_statuses %}
                <option value="{{ status }}" {% if value==status %}selected{% endif %}>{{ status }}</option>
              {% endfor %}
            </select>

          {# Default text #}
          {% else %}
            <input type="text" name="{{ name }}" class="form-control" value="{{ value }}">
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="card-footer d-flex justify-content-between align-items-center">
    <div class="d-flex gap-2">
      <a href="{{ url_for('matters_list') }}" class="btn btn-outline-secondary">Cancel</a>
      <button class="btn btn-primary" type="submit">Save</button>
    </div>

    {# Close Case button: only when editing and not already closed #}
    {% if matter and (matter['Overall Status']|lower != 'closed') %}
      <form method="post" action="{{ url_for('matters_close', mid=matter['id']) }}" onsubmit="return confirm('Close this case?');">
        <button class="btn btn-outline-danger" type="submit">Close Case</button>
      </form>
    {% endif %}
  </div>
</form>
{% endblock %}
